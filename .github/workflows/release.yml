name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release tag, e.g. v0.1.0'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: vars
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            tag="${GITHUB_REF_NAME}"
          else
            tag="${{ github.event.inputs.version }}"
          fi

          version="${tag#v}"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Build DMG and ZIP
        id: assets
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: scripts/release/build-release-assets.sh

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oak-release-${{ steps.vars.outputs.tag }}
          path: |
            ${{ steps.assets.outputs.dmg_path }}
            ${{ steps.assets.outputs.zip_path }}

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: true
          files: |
            ${{ steps.assets.outputs.dmg_path }}
            ${{ steps.assets.outputs.zip_path }}
